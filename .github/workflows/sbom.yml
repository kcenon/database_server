name: SBOM Generation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  packages: read
  security-events: write

jobs:
  generate-sbom:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Generate SBOM with Syft (CycloneDX)
      uses: anchore/sbom-action@v0
      with:
        path: .
        format: cyclonedx-json
        output-file: sbom-cyclonedx.json
        artifact-name: sbom-cyclonedx

    - name: Generate SBOM with Syft (SPDX)
      uses: anchore/sbom-action@v0
      with:
        path: .
        format: spdx-json
        output-file: sbom-spdx.json
        artifact-name: sbom-spdx

    - name: Parse CMake dependencies
      run: |
        echo "# CMake Dependencies" > cmake-dependencies.md
        echo "" >> cmake-dependencies.md
        echo "**Generated**: $(date -u)" >> cmake-dependencies.md
        echo "" >> cmake-dependencies.md
        echo "## Required Dependencies" >> cmake-dependencies.md
        echo "" >> cmake-dependencies.md
        echo "| Package | Status |" >> cmake-dependencies.md
        echo "|---------|--------|" >> cmake-dependencies.md
        echo "| common_system | REQUIRED |" >> cmake-dependencies.md
        echo "| thread_system | REQUIRED |" >> cmake-dependencies.md
        echo "| database_system | REQUIRED |" >> cmake-dependencies.md
        echo "| network_system | REQUIRED |" >> cmake-dependencies.md
        echo "" >> cmake-dependencies.md
        echo "## Optional Dependencies" >> cmake-dependencies.md
        echo "" >> cmake-dependencies.md
        echo "| Package | Status |" >> cmake-dependencies.md
        echo "|---------|--------|" >> cmake-dependencies.md
        echo "| container_system | OPTIONAL |" >> cmake-dependencies.md
        echo "| monitoring_system | OPTIONAL |" >> cmake-dependencies.md

    - name: Create combined SBOM report
      run: |
        echo "# Software Bill of Materials (SBOM)" > SBOM_REPORT.md
        echo "" >> SBOM_REPORT.md
        echo "**Repository**: ${{ github.repository }}" >> SBOM_REPORT.md
        echo "**Branch**: ${{ github.ref_name }}" >> SBOM_REPORT.md
        echo "**Commit**: ${{ github.sha }}" >> SBOM_REPORT.md
        echo "**Generated**: $(date -u)" >> SBOM_REPORT.md
        echo "" >> SBOM_REPORT.md
        echo "## Available Formats" >> SBOM_REPORT.md
        echo "" >> SBOM_REPORT.md
        echo "- **CycloneDX**: sbom-cyclonedx.json" >> SBOM_REPORT.md
        echo "- **SPDX**: sbom-spdx.json" >> SBOM_REPORT.md
        echo "" >> SBOM_REPORT.md
        cat cmake-dependencies.md >> SBOM_REPORT.md

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-${{ github.sha }}
        path: |
          sbom-cyclonedx.json
          sbom-spdx.json
          cmake-dependencies.md
          SBOM_REPORT.md
        retention-days: 90

    - name: Upload SBOM to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          sbom-cyclonedx.json
          sbom-spdx.json
          SBOM_REPORT.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Submit SBOM to Dependency Graph
      uses: advanced-security/spdx-dependency-submission-action@v0.1.1
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      continue-on-error: true
      with:
        filePath: sbom-spdx.json
